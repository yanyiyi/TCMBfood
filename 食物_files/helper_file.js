var videoAllowFormat=["avi","flv","wmv","mov","mp4","mpg"],audioAllowFormat=["mp3","wav"],docAllowFormat=["csv","doc","docx","ods","odt","pdf","ppt","pptx","txt","xls","xlsx"],fileAllowFormat=["csv","doc","docx","ods","odt","pdf","ppt","pptx","txt","xls","xlsx","bmp","gif","jpeg","jpg","png","mp4","mp3"],imgAllowFormat=["bmp","gif","jpeg","jpg","png"],allowMBSize=5,allowSize=1048576*allowMBSize,default_img_url="/Content/nrch/images/nopic.png",loading_icon_url="../Scripts/helper/loading_icon.gif",map_pushpin_img_url="/Content/nrch/images/blue-pushpin.png",onlyOneFile=[""],onlyOnePic=[];$("[name=allowMBSize]").length>0&&$("[name=allowMBSize]").each(function(){$(this).html(allowMBSize)}),$("[name=fileAllowFormat]").length>0&&$("[name=fileAllowFormat]").each(function(){$(this).html(fileAllowFormat.join(", "))}),$("[name=imgAllowFormat]").length>0&&$("[name=imgAllowFormat]").each(function(){$(this).html(imgAllowFormat.join(", "))});var byteconvert=function(e){for(var a=0;e>1024;)e/=1024,a++;return e.toFixed(1)+"BKMGT".charAt(a)},medias_upload_api=function(e){var a=new FormData;a.append("file",e),a.append("token",dqv("#hd_token")),cl("medias_upload_api file",e),$.ajax({url:"/Basic/FileStreamUpload",data:a,type:"POST",cache:!1,processData:!1,contentType:"multipart/form-data",success:function(e){cl("medias_upload_api success $ret",e),e.isSuccess},error:function(e){cl("medias_upload_api error $ret: ",e)}})},fileUpload2=function(e,a){cl("fileUpload2 . upload_area_obj",e),cl("fileUpload2 . uploader",a),loadingIconShow(e);var t=a.files;cl("fileUpload2 files",t);var o=$(a).attr("data-filetype"),i=$(a).attr("data-limitcount"),l=$(e).attr("data-file_tag"),n=$(a).attr("data-file_id"),r=$(a).attr("data-classname"),f=new FormData;if(0>=i)return alert("oops,too much file"),void loadingIconHide(e);i-=0;for(var c=0,d=0;d<t.length&&i-- >0;d++){var s=t[d].name.split(".")[t[d].name.split(".").length-1];"file"==o&&fileAllowFormat.indexOf(s.toLowerCase())<0?alert("檔案名稱: "+t[d].name+", 檔案格式不符規定"):"img"==o&&imgAllowFormat.indexOf(s.toLowerCase())<0?alert("檔案名稱: "+t[d].name+", 檔案格式不符規定"):"mp4"==s&&t[d].size>5368709120?alert("檔案名稱: "+t[d].name+", 影片大小超過5GB"):"mp4"!=s&&t[d].size>allowSize?alert("檔案名稱: "+t[d].name+", 檔案大小超過5MB"):(f.append(d,t[d]),c++)}if(c<1)loadingIconHide(e);else{var m="";"file"==o?m="/Basic/FileUpload":"img"==o&&(m="/Basic/ImgUpload");var p=e.attr("data-file_checkcode");f.append("obj_id",n),f.append("classname",r),f.append("tag",l),f.append("checkcode",p),dqv("#hd_token")&&f.append("token",dqv("#hd_token")),$.ajax({url:m,data:f,type:"POST",dataType:"json",cache:!1,processData:!1,contentType:!1,success:function(a){console.log(a),1==a.isSuccess&&(loadingIconHide(e),fileReload(e[0]))},error:function(a){cl("error $ret: ",a),loadingIconHide(e),fileReload(e[0])}}),$(a).val("")}},loadingIconShow=function(e){var a=e.find("[name=uploader_loading]");1==a.length&&(a.attr("src",loading_icon_url),a.show())},loadingIconHide=function(e){var a=e.find("[name=uploader_loading]");1==a.length&&a.hide()},trigger_file_command_execute=async function(e){var a="";if(e){var t=$(e).closest("[data-row=db_row]")[0].querySelectorAll("[data-file_area]");if(0!=t.length){if(t.length>1)for(var o=0;o<t.length;o++){var i=t[o];if(cl("file_command_group "+o+"th",i),r=$(i).data()){r.off||(r.off=[]);for(var l=0;l<r.off.length;l++){var n=r.off[l];r.off[l]=n.obj_id+";"+n.type+";"+n.tag+";"+n.name}a=await ajax_post("/Basic","FilesSwitch",r,null)}}if(1==t.length){var r=$(t[0]).data();cl("file_command",r),r.off||(r.off=[]);for(l=0;l<r.off.length;l++){n=r.off[l];r.off[l]=n.obj_id+";"+n.type+";"+n.tag+";"+n.name}a=await ajax_post("/Basic","FilesSwitch",r,null)}return a.isSuccess=!0,a}}},file_command_execute=async function(e){var a="";if(e){for(var t=e.querySelectorAll("[data-file_area]"),o=0;o<t.length;o++){var i=t[o],l=$(i).data();if(l){cl("file_command "+o+"th",l),l.off||(l.off=[]);for(var n=0;n<l.off.length;n++){var r=l.off[n];l.off[n]=r.obj_id+";"+r.type+";"+r.tag+";"+r.name}a=await ajax_post("/Basic","FilesSwitch",l,null)}}return a.isSuccess=!0,a}},file_upload_data_init=function(e,a){e&&a&&((e=$(e)).find("[data-file_id]").each(function(){$(this).attr("data-file_id",a)}),e.find("[data-file_area]").each(function(){$(this).attr("data-file_area",a),$(this).attr("data-file_checkcode",(new Date).getTime().toString()),$(this).data({on:[],off:[]})}))},fileReload=async function(e){if(e){var a=e.getAttribute("data-file_area"),t=e.getAttribute("data-file_checkcode"),o=e.getAttribute("data-file_tag"),i={obj_id:a,endmode:role_param.end,checkcode:t},l=await ajax_post("/Basic","FilesSearch",i,null);cl(o+" fileReload ret",l);var n=l.data1;if(n&&n.length>0){var r=$(e).data();r.off||(r.off=[]);var f="",c=0;if(onlyOneFile.indexOf(o)>-1&&(f="file",c=1),onlyOnePic.indexOf(o)>-1&&(f="img",c=3),f){var d=n.filter(e=>e.tag==o&&e.type==f);if(d.length>c)for(var s=c;s<d.length;s++){var m=d[s];"file"==f&&r.off.push({obj_id:m.obj_id,type:f,tag:o,name:m.id}),"img"==f&&r.off.push({obj_id:m.obj_id,type:f,tag:o,name:m.name})}}for(s=0;s<n.length;s++)if(r.off){m=n[s];r.off.filter(e=>e.type==m.type&&e.tag==o&&e.name==m.id).length>0?(n.splice(s,1),s-=1):r.off.filter(e=>e.type==m.type&&e.tag==o&&e.name==m.name).length>0&&(n.splice(s,1),s-=1)}var p=n.filter(e=>e.tag==o&&0==e.is_deleted&&0==e.is_enabled);r.on=p,$(e).data(r),cl("file_command "+o,r)}return cl("FVR_tag",o),common_role.file_view_process_controller(e,o,n),n}},ImageRemove=async function(e,a){if(confirm("確定移除?")){var t=e.attr("data-file_tag"),o=e.attr("data-file_area"),i=$(e),l=i.data();l.off||(l.off=[]),l.off.push({obj_id:o,type:"img",tag:t,name:a}),i.data(l),cl("file_command_"+t,l),fileReload(e[0])}},FileRemove=async function(e,a){if(confirm("確定移除?")){var t=e.attr("data-file_tag"),o=e.attr("data-file_area"),i=$(e),l=i.data();l.off||(l.off=[]),l.off.push({obj_id:o,type:"file",tag:t,name:a}),i.data(l),cl("file_command",l),fileReload(e[0])}},FileBatchRemove=function(e,a){if(confirm("確定移除已勾選的項目?")){var t=e.attr("data-file_tag"),o=e.attr("data-file_area"),i=$(e),l=i.data();l.off||(l.off=[]),$(a).each(function(){l.off.push({obj_id:o,type:"file",tag:t,name:this})}),i.data(l),cl("file_command",l),fileReload(e[0])}},file_note_save=async function(){var e=document.querySelectorAll("[name=file_note]");if(e.length>0)for(var a=0;a<e.length;a++){var t=e[a].getAttribute("data-file_id"),o=$(e[a]).val();await ajax_post("/Basic","FilesNoteSave",{file_id:t,note:o},null)}},file_info_save=async function(){var e=document.querySelectorAll("[name=file_info]");if(e.length>0)for(var a=0;a<e.length;a++){var t=e[a].getAttribute("data-file_id"),o=(e[a].querySelector("[name=casepic1]")?e[a].querySelector("[name=casepic1]").value:"")+";"+(e[a].querySelector("[name=authorizeRange1]")?e[a].querySelector("[name=authorizeRange1]").value:"")+";"+(e[a].querySelector("[name=representpic]")?e[a].querySelector("[name=representpic]").checked:"")+";"+(e[a].querySelector("[name=owner]")?e[a].querySelector("[name=owner]").value:"")+";"+(e[a].querySelector("[name=exif]")?e[a].querySelector("[name=exif]").value:"");await ajax_post("/Basic","FilesNoteSave",{file_id:t,note:o},null)}},file_sort_save=async function(){var e=document.querySelectorAll("[name=file_sort]");if(e.length>0)for(var a=0;a<e.length;a++){var t=e[a].getAttribute("data-file_id"),o=$(e[a]).val();await ajax_post("/Basic","FilesSortSave",{file_id:t,sort:o},null)}},importExcel=function(e,a){if(0!=confirm("確認匯入?")){cl("fileUpload2 . upload_area_obj",e),cl("fileUpload2 . uploader",a),loadingIconShow(e);var t=a.files;cl("fileUpload2 files",t);for(var o=$(a).attr("data-tag"),i=new FormData,l=0,n=0;n<t.length;n++)i.append(n,t[n]),l++;if(l<1)loadingIconHide(e);else{$.ajax({url:"/Member/MemberDataImport?tag="+o,data:i,type:"POST",dataType:"json",cache:!1,processData:!1,contentType:!1,success:function(a){if(loadingIconHide(e),cl("importExcel $ret",a),1==a.isSuccess&&alert("更新成功"),0==a.isSuccess){var t=import_error_obj_to_msg(a.data1);t&&alert(t)}func_member_start()},error:function(a){cl("error $ret: ",a),alert("oops"),loadingIconHide(e)}}),$(a).val("")}}else $(a).val("")},import_error_obj_to_msg=function(e){var a="";if(e&&0!=e.length)return $(e).each(function(){var e=this.row_number;a+="第"+e+"行 ";var t=this.checkResult;$(t).each(function(){var e=this.checkTag;a+="["+e+"]: ";var t="";this.checkResult.length>0&&(t=this.checkResult[0]),a+=langTrans("error_"+t)+"; "}),a+="\r"}),a};